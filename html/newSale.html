<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width = device-width, initial-scale = 1">
    <link href="../css/search.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
        integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
        integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $.ajax({
            async: false,
            url: "../php/checkLogin.php",    //the page containing php script
            type: "post",    //request type,
            data: {},
            dataType: "json",
            success: function (result) {
                if (!result) {
                    document.location.href = "index.html";
                }
            }
        });
    </script>
    <title>New Sale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="../css/masterFile.css" rel="stylesheet">
</head>

<body>
    <header>
        <h1>New Sale</h1>
        <button class="home_Button buttonText_Aqua" onclick="window.location.href = 'home.html'">
            Home
        </button>
        <button class="logout_Button buttonText_Aqua">
            Logout
        </button>
    </header>

    <div>
        <div class="tab">
            <h1>Customer's Name:</h1>
            <div id="customerSearch">
                <input oninput="searchCustomers(this.value);" id="customerName" type="text">
                <div id="customerSearchResults">

                </div>
            </div>
            <div>
                <button onclick="nextTab();" style="width: 15%;">Next</button>
            </div>
        </div>

        <div class="tab fork">
            <h1>New Customer:</h1>
            <h2>First Name:</h2>
            <input id="newCustomerFirstName" type="text">
            <h2>Last Name:</h2>
            <input id="newCustomerLastName" type="text">
            <h2>Phone Number:</h2>
            <input id="newCustomerPhoneNumber" type="text">
            <h2>Address (Optional):</h2>
            <input id="newCustomerAddress" type="text">
            <h2>Email (Optional):</h2>
            <input id="newCustomerEmail" type="text">
            <div>
                <button onclick="prevTab();" style="width: 15%;">Back</button>
                <button onclick="addNewCustomer();" style="width: 15%;">Next</button>
            </div>
        </div>

        <div class="tab">
            <h1>Customer Vehicle:</h1>
            <div id="carSearch">
                <input oninput="searchCars(this.value);" id="carName" type="text">
                <div id="carSearchResults">

                </div>
            </div>
            <div>
                <button onclick="prevTab();" style="width: 15%;">Back</button>
                <button onclick="nextTab();" style="width: 15%;">Next</button>
            </div>
        </div>
        <div class="tab fork">
            <h1 id="addCarHeader">Add New Car to Customer Profile:</h1>
            <h2>Make:</h2>
            <div id="makeSearch" style="position: relative">
                <input oninput="searchExistingMakes(this.value); carDoesntExist();" onchange="carDoesntExist();"
                    id="carMake" type="text">
                <span id="makePlaceholder" class="placeholderCustom"></span>
            </div>
            <h2>Model:</h2>
            <div id="modelSearch" style="position: relative">
                <input oninput="searchExistingModels(this.value); carDoesntExist();" onchange="carDoesntExist();"
                    id="carModel" type="text">
                <span id="modelPlaceholder" class="placeholderCustom"></span>
            </div>
            <h2>Year</h2>
            <div id="yearSearch">
                <input oninput="carDoesntExist();" id="carYear" type="text">
            </div>
            <span id="carExistsConfirmation" style="color: green; display: none;">This car exists in the
                database!</span>
            <div id="refrigerentCapacityPrompt">
                <h2>Refrigerent Capacity</h2>
                <input id="carRefrigerent" type="text">
            </div>
            <div>
                <button onclick="prevTab();" style="width: 15%;">Back</button>
                <button onclick="addNewCar();" style="width: 15%;">Next</button>
            </div>
        </div>
        <div class="tab">
            <h1>Appointment Details:</h1>
            <div style="display: flex; flex-direction: column;">
                <span>Start Date:</span> <input oninput="" id="startDateInput" type="datetime-local">
            </div>
            <div style="display: flex; flex-direction: column;">
                <span>End Date:</span> <input oninput="" id="endDateInput" type="datetime-local">
            </div>
            <div style="display: flex; flex-direction: column;">
                <span>Location:</span> <input oninput="" id="locationInput" type="text">
            </div>
            <div style="display: flex; flex-direction: column;">
                <span>Notes:</span> <textarea oninput="" id="notesInput"></textarea>
            </div>
            <div style="display: flex; flex-direction: column; align-items: flex-start">
                <span>Start job now?:</span> <input type="checkbox" id="startJobNow"></input>
            </div>
            <div>
                <button onclick="prevTab();" style="width: 15%;">Back</button>
                <button onclick="createAppointment();" style="width: 15%;">Create Appointment</button>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
    var currentTab = 0;
    var selectedCustomerID = null;
    var selectedCustomerName = null;
    var selectedCarID = null;
    var selectedCustomersCarID = null;
    $(':input').val('');

    const tabs = document.getElementsByClassName("tab");
    for (var i = 1; i < tabs.length; i++) {
        tabs[i].style.display = "none";
    }

    function searchCustomers(name) {
        selectedCustomerID = null;
        selectedCustomerName = null;
        var results = null;
        document.getElementById("customerSearchResults").style.display = "flex";
        $.ajax({
            async: false,
            url: "../php/commonQueryFunctions.php",    //the page containing php script
            type: "post",    //request type,
            data: { "action": "fetchCustomerByParameters", "search": name },
            dataType: "json",
            success: function (result) {
                results = result;
            }
        });

        var resultsDisplay = document.getElementById("customerSearchResults");
        while (resultsDisplay.hasChildNodes()) {
            resultsDisplay.removeChild(resultsDisplay.firstChild);
        }
        if (results.length == 0 && name.match(/^\s*&/)) {
            document.getElementById("customerSearchResults").style.display = "none";
        }
        else {
            var resultsElements = new Array(results.length);
            for (var i = 0; i < resultsElements.length; i++) {
                resultsElements[i] = document.createElement("div");
                resultsElements[i].classList.add("result");
                resultsElements[i].setAttribute("cust_id", results[i].cust_id);
                resultsElements[i].addEventListener("click", selectCustomer);
                resultsElements[i].innerHTML = results[i].f_name + " " + results[i].l_name;
                resultsDisplay.appendChild(resultsElements[i]);
            }
            var createNewCustomerButton = document.createElement("div");
            createNewCustomerButton.classList.add("result");
            createNewCustomerButton.addEventListener("click", transferToAddNewCustomer);
            createNewCustomerButton.innerHTML = "Add New Customer...";
            resultsDisplay.appendChild(createNewCustomerButton);
        }
    }

    function searchCars(name) {
        selectedCar = null;
        var results;
        document.getElementById("carSearchResults").style.display = "flex";
        $.ajax({
            async: false,
            url: "../php/commonQueryFunctions.php",    //the page containing php script
            type: "post",    //request type,
            data: { "action": "fetchCarByParameters", "search": name, "cust_id": selectedCustomerID },
            dataType: "json",
            success: function (result) {
                results = result;
            }
        });
        var resultsDisplay = document.getElementById("carSearchResults");
        while (resultsDisplay.hasChildNodes()) {
            resultsDisplay.removeChild(resultsDisplay.firstChild);
        }
        if (results.length == 0 && name.match(/^\s*&/)) {
            document.getElementById("carSearchResults").style.display = "none";
        }
        else {
            var resultsElements = new Array(results.length);
            for (var i = 0; i < resultsElements.length; i++) {
                resultsElements[i] = document.createElement("div");
                resultsElements[i].classList.add("result");
                resultsElements[i].setAttribute("id", results[i].id);
                resultsElements[i].addEventListener("click", selectCar);
                resultsElements[i].innerHTML = results[i].Make + " " + results[i].Model + ", " + results[i].Year;
                resultsDisplay.appendChild(resultsElements[i]);
            }
            var createNewCustomerButton = document.createElement("div");
            createNewCustomerButton.classList.add("result");
            createNewCustomerButton.addEventListener("click", transferToAddNewCar);
            createNewCustomerButton.innerHTML = "Add new car to customer profile...";
            resultsDisplay.appendChild(createNewCustomerButton);
        }
    }

    function searchExistingMakes(make) {
        document.onkeydown = function (e) {
            if (e.which == 39 || (e.which == 9 && document.getElementById("makePlaceholder").innerHTML != "")) {
                document.getElementById("carMake").value = document.getElementById("makePlaceholder").innerHTML.charAt(0).toUpperCase() + document.getElementById("makePlaceholder").innerHTML.slice(1);
                carDoesntExist();
                document.getElementById("makePlaceholder").innerHTML = "";
            }
        };
        $("#carMake").blur(function () {
            document.getElementById("makePlaceholder").innerHTML = "";
        });
        if (!make.match(/^\s+.*$/) && make != "") {
            $.ajax({
                async: false,
                url: "../php/commonQueryFunctions.php",    //the page containing php script
                type: "post",    //request type,
                data: { "action": "fetchExistingMakesTop", "search": make },
                success: function (result) {
                    document.getElementById("makePlaceholder").innerHTML = make + result.substring(make.length);
                }
            });
        }
        else {
            document.getElementById("makePlaceholder").innerHTML = "";
        }
    }
    function searchExistingModels(model) {
        document.onkeydown = function (e) {
            if (e.which == 39 || (e.which == 9 && document.getElementById("modelPlaceholder").innerHTML != "")) {
                document.getElementById("carModel").value = document.getElementById("modelPlaceholder").innerHTML.charAt(0).toUpperCase() + document.getElementById("modelPlaceholder").innerHTML.slice(1);
                carDoesntExist();
                document.getElementById("modelPlaceholder").innerHTML = "";
            }
        };
        $("#carModel").blur(function () {
            document.getElementById("modelPlaceholder").innerHTML = "";
        });
        if (!model.match(/^\s+.*$/) && model != "") {
            $.ajax({
                async: false,
                url: "../php/commonQueryFunctions.php",    //the page containing php script
                type: "post",    //request type,
                data: { "action": "fetchExistingModelsTop", "search": model },
                success: function (result) {
                    document.getElementById("modelPlaceholder").innerHTML = model + result.substring(model.length);
                }
            });
        }
        else {
            document.getElementById("modelPlaceholder").innerHTML = "";
        }
    }
    function carDoesntExist() {
        var year = document.getElementById("carYear").value;
        if (year.match(/^\d+$/)) {
            $.ajax({
                async: false,
                url: "../php/commonQueryFunctions.php",    //the page containing php script
                type: "post",    //request type,
                data: { "action": "searchCars", "make": document.getElementById("carMake").value, "model": document.getElementById("carModel").value, "year": year },
                success: function (result) {
                    if (result != "") {
                        document.getElementById("carExistsConfirmation").style.display = "inline";
                        document.getElementById("refrigerentCapacityPrompt").style.display = "none";
                        document.getElementById("refrigerentCapacityPrompt").value = "";
                        selectedCarID = result;
                    }
                    else {
                        document.getElementById("carExistsConfirmation").style.display = "none";
                        document.getElementById("refrigerentCapacityPrompt").style.display = "inline";
                        selectedCarID = null;
                    }
                }
            });
        }
        else {
            document.getElementById("carExistsConfirmation").style.display = "none";
            document.getElementById("refrigerentCapacityPrompt").style.display = "inline";
            selectedCarID = null;
        }
    }

    function selectCustomer() {
        document.getElementById("customerName").value = this.innerHTML;
        selectedCustomerID = this.getAttribute("cust_id");
        selectedCustomerName = this.innerHTML;
        var resultsDisplay = document.getElementById("customerSearchResults");
        while (resultsDisplay.hasChildNodes()) {
            resultsDisplay.removeChild(resultsDisplay.firstChild);
        }
        document.getElementById("customerSearchResults").style.display = "none";
    }
    function selectCar() {
        document.getElementById("carName").value = this.innerHTML;
        selectedCustomersCarID = this.getAttribute("id");
        var resultsDisplay = document.getElementById("carSearchResults");
        while (resultsDisplay.hasChildNodes()) {
            resultsDisplay.removeChild(resultsDisplay.firstChild);
        }
        document.getElementById("carSearchResults").style.display = "none";
    }

    function transferToAddNewCustomer() {
        tabs[currentTab].style.display = "none";
        currentTab = 1;
        tabs[currentTab].style.display = "flex";

        var tempName = document.getElementById("customerName").value;
        if (!tempName.match(/^\d+$/)) {
            const tempNameSplit = tempName.split(" ");
            if (tempNameSplit.length > 1) {
                document.getElementById("newCustomerFirstName").value = tempNameSplit[0].charAt(0).toUpperCase() + tempNameSplit[0].slice(1);
                document.getElementById("newCustomerLastName").value = tempNameSplit[1].charAt(0).toUpperCase() + tempNameSplit[1].slice(1);
            }
            else {
                document.getElementById("newCustomerFirstName").value = tempNameSplit[0].charAt(0).toUpperCase() + tempNameSplit[0].slice(1);
            }
        }
        else {
            document.getElementById("newCustomerPhoneNumber").value = tempName;
        }
    }
    function transferToAddNewCar() {
        tabs[currentTab].style.display = "none";
        currentTab = 3;
        tabs[currentTab].style.display = "flex";
        if (selectedCustomerName.charAt(selectedCustomerName.length) != 's') {
            document.getElementById("addCarHeader").innerHTML = "Add Car to " + selectedCustomerName + "'s Profile:";
        }
        else {
            document.getElementById("addCarHeader").innerHTML = "Add Car to " + selectedCustomerName + "' Profile:";
        }
    }

    function addNewCustomer() {
        $.ajax({
            async: false,
            url: "../php/addCustomer.php",    //the page containing php script
            type: "post",    //request type,
            dataType: "json",
            data: {
                "fname": document.getElementById("newCustomerFirstName").value,
                "lname": document.getElementById("newCustomerLastName").value,
                "phone": document.getElementById("newCustomerPhoneNumber").value,
                "address": document.getElementById("newCustomerAddress").value,
                "email": document.getElementById("newCustomerEmail").value,
                "needId": true
            },
            success: function (result) {
                selectedCustomerID = result.cust_id;
                selectedCustomerName = result.f_name + " " + result.l_name;
                nextTab();
            }
        });
    }

    function addNewCar() {
        if (selectedCarID == null) {
            $.ajax({
                async: false,
                url: "../php/addCar.php",    //the page containing php script
                type: "post",    //request type,
                data: {
                    "make": document.getElementById("carMake").value,
                    "model": document.getElementById("carModel").value,
                    "year": document.getElementById("carYear").value,
                    "refrigerent": document.getElementById("carRefrigerent").value,
                    "cust_id": selectedCustomerID,
                },
                success: function (result) {
                    selectedCustomersCarID = result;
                    nextTab();
                }
            });
        }
        else {
            $.ajax({
                async: false,
                url: "../php/commonQueryFunctions.php",    //the page containing php script
                type: "post",    //request type,
                data: { "action": "addCustomersCarRelation", "cust_id": selectedCustomerID, "car_id": selectedCarID },
                success: function (result) {
                    selectedCustomersCarID = result;
                    nextTab();
                }
            });
        }
    }

    function nextTab() {
        tabs[currentTab].style.display = "none";
        do {
            currentTab++;
        } while (tabs[currentTab].classList.contains("fork"));
        tabs[currentTab].style.display = "flex";
    }

    function prevTab() {
        $(':input').val('');
        tabs[currentTab].style.display = "none";
        do {
            currentTab--;
        } while (tabs[currentTab].classList.contains("fork"));
        tabs[currentTab].style.display = "flex";
    }

    function createAppointment() {
        $.ajax({
            async: false,
            url: "../php/commonQueryFunctions.php",    //the page containing php script
            type: "post",    //request type,
            data: { "action": "createAppointmentAndInvoice", "cust_id": selectedCustomerID, "cust_car_id": selectedCustomersCarID, "start_date": document.getElementById("startDateInput").value, "end_date": document.getElementById("endDateInput").value, "location": document.getElementById("locationInput").value, "notes": document.getElementById("notesInput").value },
            success: function (result) {
                if (document.getElementById("startJobNow").checked) {
                    location.href = "invoice.html?invoice_id=" + result;
                }
                else {
                    location.href = "schedule.html";
                }
            }
        });
    }

</script>

</html>